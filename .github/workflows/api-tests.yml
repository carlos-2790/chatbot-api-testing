name: API Tests & Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
#   schedule:
#     # Run daily at 9 AM UTC
#     - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install formatting tools
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8
    
    - name: Check code formatting with Black
      run: |
        black --check src/ tests/ *.py
      continue-on-error: false
    
    - name: Check import sorting with isort
      run: |
        isort --check src/ tests/ *.py
      continue-on-error: false
    
    - name: Lint with flake8
      run: |
        flake8 src/ tests/ --max-line-length=100 --extend-ignore=E203,W503
      continue-on-error: true

  test:
    name: Run Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install torch --extra-index-url https://download.pytorch.org/whl/cpu
        pip install -r requirements.txt
    
    - name: Create reports directory
      run: mkdir -p reports
    
    - name: Set PYTHONPATH
      run: echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
    
    - name: Run smoke tests
      run: |
        pytest -v -m smoke --html=reports/smoke-report-py${{ matrix.python-version }}.html --self-contained-html
      continue-on-error: false
    
    - name: Run quality tests
      run: |
        pytest -v -m quality --html=reports/quality-report-py${{ matrix.python-version }}.html --self-contained-html
      continue-on-error: true
      timeout-minutes: 10
    
    - name: Run all tests with coverage
      run: |
        pytest -v --cov=src --cov-report=html --cov-report=term --cov-report=xml --html=reports/full-report-py${{ matrix.python-version }}.html --self-contained-html
      timeout-minutes: 15
    
    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-py${{ matrix.python-version }}
        path: reports/
        retention-days: 30
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-py${{ matrix.python-version }}
        path: htmlcov/
        retention-days: 30
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: matrix.python-version == '3.11'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

  test-docker:
    name: Run Tests with Docker
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create .env file
      run: |
        cp .env.example .env
    
    - name: Build Docker image
      run: |
        docker compose build
    
    - name: Run smoke tests in Docker
      run: |
        docker compose run --rm chatbot-tests pytest -v -m smoke
      continue-on-error: false
    
    - name: Run quality tests in Docker
      run: |
        docker compose run --rm chatbot-tests pytest -v -m quality
      continue-on-error: true
      timeout-minutes: 10
    
    - name: Run all tests with coverage in Docker
      run: |
        docker compose run --rm chatbot-tests pytest -v --cov=src --cov-report=html --cov-report=term --cov-report=xml --html=reports/docker-report.html --self-contained-html
      timeout-minutes: 15
    
    - name: Upload Docker test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: docker-test-reports
        path: reports/
        retention-days: 30
    
    - name: Upload Docker coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: docker-coverage-report
        path: htmlcov/
        retention-days: 30

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [test, test-docker]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install torch --extra-index-url https://download.pytorch.org/whl/cpu
        pip install -r requirements.txt
    
    - name: Set PYTHONPATH
      run: echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
    
    - name: Run quality validation
      run: |
        python test_quality.py
      env:
        QUALITY_THRESHOLD: 0.85
    
    - name: Check quality threshold
      run: |
        echo "âœ… Quality gate passed!"

  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [code-quality, test, quality-gate]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Comment PR with results
      uses: actions/github-script@v7
      with:
        script: |
          const message = `## ðŸŽ‰ CI/CD Results
          
          âœ… **Code Quality**: Passed
          âœ… **Tests**: Passed
          âœ… **Quality Gate**: Passed
          
          All checks completed successfully! ðŸš€
          
          Check the [Actions tab](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed reports.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: quality-gate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to GitHub Pages (placeholder)
      run: |
        echo "ðŸ“š Documentation deployment would happen here"
        echo "You can add MkDocs, Sphinx, or other documentation tools"
